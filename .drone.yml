kind: pipeline
name: amd64

platform:
  os: linux
  arch: amd64

steps:
  - name: download
    image: alpine
    commands:
      - ./scripts/download-amd64
  - name: docker
    image: plugins/docker
    settings:
      dockerfile: Dockerfile
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      repo: rancher/calico-cni
      tag: ${DRONE_TAG}-linux-amd64
    when:
      instance:
        - drone-publish.rancher.io
      event: tag
---
kind: pipeline
name: arm64

platform:
  os: linux
  arch: arm64

steps:
  - name: download
    image: alpine
    commands:
      - ./scripts/download-arm64
  - name: docker
    image: plugins/docker
    settings:
      dockerfile: Dockerfile
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      repo: rancher/calico-cni
      tag: ${DRONE_TAG}-linux-arm64
    when:
      instance:
        - drone-publish.rancher.io
      event: tag
---
kind: pipeline
name: manifest

steps:
  - name: push-manifest
    image: plugins/manifest:1.1.0
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      spec: manifest.tmpl
      ignore_missing: true
    when:
      instance:
        - drone-publish.rancher.io
      event:
        - tag
depends_on:
- amd64
- arm64